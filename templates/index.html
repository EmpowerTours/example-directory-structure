<!DOCTYPE html>
<html lang="en">
<head>
   <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmpowerTours</title>
    <!-- Load HTMX for dynamic content -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <!-- Load web3.js as a module for wallet connection -->
    <script src="/static/js/web3.js" type="module" defer></script>
</head>
<body>
    <h1>Welcome to EmpowerTours</h1>

    <h1>EmpowerTours: Approve $TOURS for Game</h1>
    <p>Connect your MetaMask wallet to approve the escrow contract for 1 $TOURS.</p>
    <button id="approveButton" onclick="approveTours()" disabled>Approve $TOURS</button>
    <div id="status"></div>

    <script>
        const TOURS_CONTRACT_ADDRESS = "0x2Da15A8B55BE310A7AB8EB0010506AB30CD6CBcf";
        const ESCROW_CONTRACT_ADDRESS = "0x1BC922D67Cbc0dAf9C06442a80cE32009Ff02DCF";
        const TOURS_ABI = [
            {
                "constant": False,
                "inputs": [
                    {"name": "_spender", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "type": "function"
            },
            {
                "constant": True,
                "inputs": [
                    {"name": "_owner", "type": "address"},
                    {"name": "_spender", "type": "address"}
                ],
                "name": "allowance",
                "outputs": [{"name": "", "type": "uint256"}],
                "type": "function"
            }
        ];

        // Wait for Web3.js to load
        window.onload = function() {
            const status = document.getElementById("status");
            const approveButton = document.getElementById("approveButton");

            if (typeof Web3 === "undefined") {
                status.textContent = "Error: Web3.js failed to load. Please refresh the page or check your internet connection.";
                console.error("Web3.js is not defined. Check CDN or network issues.");
                return;
            }

            if (!window.ethereum) {
                status.textContent = "MetaMask not detected. Please install MetaMask and connect to the Monad testnet.";
                console.error("MetaMask not detected.");
                return;
            }

            approveButton.disabled = false;
            status.textContent = "Ready to approve. Click the button to connect MetaMask.";
        };

        async function approveTours() {
            const status = document.getElementById("status");
            status.textContent = "Connecting to MetaMask...";
            console.log("Attempting to connect to MetaMask...");

            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                const userAddress = accounts[0];
                console.log("Connected account:", userAddress);

                // Ensure Monad testnet
                await window.ethereum.request({
                    method: "wallet_switchEthereumChain",
                    params: [{ chainId: "0x279f" }], // Monad testnet chain ID: 10111
                });

                // Initialize Web3
                const web3 = new Web3(window.ethereum);
                const toursContract = new web3.eth.Contract(TOURS_ABI, TOURS_CONTRACT_ADDRESS);

                // Check current allowance
                status.textContent = "Checking current allowance...";
                const allowance = await toursContract.methods.allowance(userAddress, ESCROW_CONTRACT_ADDRESS).call();
                console.log("Current allowance:", allowance / 10**18, "$TOURS");

                if (parseInt(allowance) >= 1000000000000000000) {
                    status.textContent = "Approval already granted. You can close this page and return to Telegram.";
                    console.log("Sufficient allowance detected.");
                    return;
                }

                // Approve 1 $TOURS
                status.textContent = "Please sign the transaction in MetaMask...";
                console.log("Initiating approve transaction...");
                const tx = await toursContract.methods.approve(ESCROW_CONTRACT_ADDRESS, "1000000000000000000").send({ from: userAddress });
                status.textContent = `Approval successful! Transaction hash: ${tx.transactionHash}. Return to Telegram and click 'Accept' again.`;
                console.log("Approval transaction successful:", tx.transactionHash);
            } catch (error) {
                status.textContent = `Error: ${error.message}. Please try again or install MetaMask.`;
                console.error("Approval error:", error);
            }
        }
    </script>


    <!-- Sign Up Form -->
    <h2>Sign Up</h2>
    <form id="signup-form" hx-post="/signup" hx-target="#response">
        <input type="text" name="username" placeholder="Enter username" required>
        <input type="password" name="password" placeholder="Create password" required>
        <button type="submit">Sign Up</button>
    </form>
    <div id="response"></div>

    <!-- Booking Section -->
    <h2>Book a Climbing Slot</h2>
    <button hx-get="/booking" hx-target="#booking-content">View Booking</button>
    <div id="booking-content"></div>

    <!-- Marketplace Section -->
    <h2>Visit Marketplace</h2>
    <button hx-get="/marketplace" hx-target="#marketplace-content">Go to Marketplace</button>
    <div id="marketplace-content"></div>
</body>
</html>
