<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmpowerTours - Approve $TOURS</title>
    <script src="/web3.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #status { margin-top: 20px; color: red; }
        a { color: blue; text-decoration: underline; }
        #txHash { word-break: break-all; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>EmpowerTours: Approve $TOURS for Game</h1>
    <p>Connect your MetaMask wallet to approve the escrow contract for 1 $TOURS.</p>
    <button id="approveButton" onclick="approveTours()" disabled>Approve $TOURS</button>
    <p id="fallback" style="display: none;">
        Please open this page in an external browser with MetaMask installed: 
        <a id="currentUrl"></a>
    </p>
    <div id="status"></div>
    <div id="txHash"></div>

    <script>
        const TOURS_CONTRACT_ADDRESS = "0x2Da15A8B55BE310A7AB8EB0010506AB30CD6CBcf";
        const ESCROW_CONTRACT_ADDRESS = "0x1BC922D67Cbc0dAf9C06442a80cE32009Ff02DCF";
        const TOURS_ABI = [
            {
                "constant": false,
                "inputs": [
                    {"name": "_spender", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {"name": "_owner", "type": "address"},
                    {"name": "_spender", "type": "address"}
                ],
                "name": "allowance",
                "outputs": [{"name": "", "type": "uint256"}],
                "type": "function"
            }
        ];

        // Telegram Web App integration
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            console.log("Telegram Web App initialized");
            // Prompt to open external browser
            window.Telegram.WebApp.showAlert(
                "MetaMask is not supported in Telegram's in-app browser. Please open this page in an external browser with MetaMask installed.",
                () => window.Telegram.WebApp.openLink(window.location.href)
            );
        }

        // Initialize page
        function initialize() {
            const status = document.getElementById("status");
            const approveButton = document.getElementById("approveButton");
            const fallback = document.getElementById("fallback");
            const currentUrl = document.getElementById("currentUrl");

            // Set current URL for fallback
            currentUrl.textContent = window.location.href;
            currentUrl.href = window.location.href;

            console.log("Initializing approval page...");

            // Check Web3.js
            if (typeof Web3 === "undefined") {
                status.textContent = "Error: Web3.js failed to load. Please refresh the page or open in an external browser with MetaMask installed.";
                console.error("Web3.js is not defined. Check local file or network issues.");
                fallback.style.display = "block";
                return;
            }

            // Check MetaMask
            if (!window.ethereum) {
                status.textContent = "MetaMask not detected. Please open this page in an external browser with MetaMask installed.";
                console.error("MetaMask not detected.");
                fallback.style.display = "block";
                return;
            }

            // Enable button
            approveButton.disabled = false;
            status.textContent = "Ready to approve. Click the button to connect MetaMask.";
            console.log("Web3.js and MetaMask detected. Button enabled.");
        }

        // Run initialization after scripts load
        window.addEventListener("load", initialize);

        async function approveTours() {
            const status = document.getElementById("status");
            const txHashDiv = document.getElementById("txHash");
            status.textContent = "Connecting to MetaMask...";
            console.log("Attempting to connect to MetaMask...");

            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                const userAddress = accounts[0];
                console.log("Connected account:", userAddress);

                // Ensure Monad testnet
                try {
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: "0x279f" }], // Monad testnet chain ID: 10111
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: "wallet_addEthereumChain",
                            params: [{
                                chainId: "0x279f",
                                chainName: "Monad Testnet",
                                rpcUrls: ["https://testnet-rpc.monad.xyz"],
                                nativeCurrency: { name: "MON", symbol: "MON", decimals: 18 },
                                blockExplorerUrls: ["https://testnet.monadscan.com"]
                            }]
                        });
                    } else {
                        throw switchError;
                    }
                }

                // Initialize Web3
                const web3 = new Web3(window.ethereum);
                const toursContract = new web3.eth.Contract(TOURS_ABI, TOURS_CONTRACT_ADDRESS);

                // Check current allowance
                status.textContent = "Checking current allowance...";
                const allowance = await toursContract.methods.allowance(userAddress, ESCROW_CONTRACT_ADDRESS).call();
                console.log("Current allowance:", allowance / 10**18, "$TOURS");

                if (parseInt(allowance) >= 1000000000000000000) {
                    status.textContent = "Approval already granted. Return to Telegram and click 'Accept' again.";
                    console.log("Sufficient allowance detected.");
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.close();
                    }
                    return;
                }

                // Check balance
                status.textContent = "Checking $TOURS balance...";
                const balance = await toursContract.methods.balanceOf(userAddress).call();
                console.log("Current balance:", balance / 10**18, "$TOURS");
                if (parseInt(balance) < 1000000000000000000) {
                    status.textContent = "Insufficient $TOURS balance. Please fund your wallet with at least 1 $TOURS.";
                    console.error("Insufficient $TOURS balance:", balance / 10**18);
                    return;
                }

                // Approve 1 $TOURS
                status.textContent = "Please sign the transaction in MetaMask...";
                console.log("Initiating approve transaction...");
                const tx = await toursContract.methods.approve(ESCROW_CONTRACT_ADDRESS, "1000000000000000000").send({ from: userAddress });
                status.textContent = "Approval successful! Return to Telegram and click 'Accept' to start the game.";
                txHashDiv.textContent = `Transaction hash: ${tx.transactionHash}`;
                console.log("Approval transaction successful:", tx.transactionHash);
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.showAlert(
                        "Approval successful! Please return to Telegram and click 'Accept' again to start the game.",
                        () => window.Telegram.WebApp.close()
                    );
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}. Please try again in an external browser with MetaMask or manually approve in Remix.`;
                console.error("Approval error:", error);
                document.getElementById("fallback").style.display = "block";
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.showAlert(
                        `Approval failed: ${error.message}. Please open in an external browser or use Remix.`,
                        () => window.Telegram.WebApp.openLink(window.location.href)
                    );
                }
            }
        }
    </script>


    <!-- Sign Up Form -->
    <h2>Sign Up</h2>
    <form id="signup-form" hx-post="/signup" hx-target="#response">
        <input type="text" name="username" placeholder="Enter username" required>
        <input type="password" name="password" placeholder="Create password" required>
        <button type="submit">Sign Up</button>
    </form>
    <div id="response"></div>

    <!-- Booking Section -->
    <h2>Book a Climbing Slot</h2>
    <button hx-get="/booking" hx-target="#booking-content">View Booking</button>
    <div id="booking-content"></div>

    <!-- Marketplace Section -->
    <h2>Visit Marketplace</h2>
    <button hx-get="/marketplace" hx-target="#marketplace-content">Go to Marketplace</button>
    <div id="marketplace-content"></div>
</body>
</html>
